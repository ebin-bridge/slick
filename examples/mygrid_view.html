<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <title>SlickGrid example 4: Model</title>
  <link rel="stylesheet" href="slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="slick.pager.css" type="text/css"/>
  <link rel="stylesheet" href="jquery-ui-1.8.16.custom.css" type="text/css"/>
  <link rel="stylesheet" href="examples.css" type="text/css"/>
  <link rel="stylesheet" href="slick.columnpicker.css" type="text/css"/>
  <style>
    .cell-title {
      font-weight: bold;
    }

    .cell-effort-driven {
      text-align: center;
    }

    .cell-selection {
      background: #f5f5f5;
      color: gray;
      text-align: center;
      font-size: 10px;
    }

    .slick-row.selected .cell-selection {
      background-color: transparent; /* show default selected row background */
    }
	.slick-header-column { text-align : center !important; }
  </style>
</head>

<body>

	<div style="position:relative">
  <div style="width:100%;">
    <div class="grid-header" style="width:100%">
      <label>SlickGrid</label>
      <span style="float:right" class="ui-icon ui-icon-search" title="Toggle search panel"
            onclick="toggleFilterRow()"></span>
    </div>
    <div id="myGrid" style="width:100%;height:500px;"></div>
    <div id="pager" style="width:100%;height:20px;"></div>
  </div>

  
</div>

<div id="inlineFilterPanel" style="display:none;background:#dddddd;padding:3px;color:black;">
  Show tasks with title including <input type="text" id="txtSearch2">
  and % at least &nbsp;
  <div style="width:100px;display:inline-block;" id="pcSlider2"></div>
</div>












<script src="jquery-1.7.min.js"></script>
<script src="jquery-ui-1.8.16.custom.min.js"></script>
<script src="jquery.event.drag-2.2.js"></script>
<script src="slick.core.js"></script>
<script src="slick.formatters.js"></script>
<script src="slick.editors.js"></script>
<script src="slick.rowselectionmodel.js"></script>
<script src="slick.grid.js"></script>
<script src="slick.dataview.js"></script>
<script src="slick.pager.js"></script>
<script src="slick.columnpicker.js"></script>



<script>

var dataPage = 'woFilterAllCopy';
//var siteURL='/Kund/Bridge/workorder.nsf' + '/' + dataPage;
var siteURL='/Kund/Bridge/workorder.nsf' + '/' + dataPage;

var dataView;
var grid;
var data = [];
var i = 0;
var row = 0;
var columns = [];
var ajax = 0;
var options = {
  editable: true,
  enableAddRow: true,
  enableCellNavigation: true,
  asyncEditorLoading: true,
  forceFitColumns: false,
  topPanelHeight: 25
};

var sortcol = "title";
var sortdir = 1;
var percentCompleteThreshold = 0;
var searchString = "";
var queued  = [];
var loopcount = 0;
var primeWorker = new Worker('worker.js');

function requiredFieldValidator(value) {
  if (value == null || value == undefined || !value.length) {
    return {valid: false, msg: "This is a required field"};
  }
  else {
    return {valid: true, msg: null};
  }
}

function myFilter(item, args) {
  if (item["percentComplete"] < args.percentCompleteThreshold) {
    return false;
  }

  if (args.searchString != "" && item["title"].indexOf(args.searchString) == -1) {
    return false;
  }

  return true;
}

function percentCompleteSort(a, b) {
  return a["percentComplete"] - b["percentComplete"];
}

function comparer(a, b) {
  var x = a[sortcol], y = b[sortcol];
  return (x == y ? 0 : (x > y ? 1 : -1));
}

function toggleFilterRow() {
  grid.setTopPanelVisibility(!grid.getOptions().showTopPanel);
}



$(".grid-header .ui-icon")
        .addClass("ui-state-default ui-corner-all")
        .mouseover(function (e) {
          $(e.target).addClass("ui-state-hover")
        })
        .mouseout(function (e) {
          $(e.target).removeClass("ui-state-hover")
});

function getcolumn(){
  return $.ajax({
  type: "GET",
  //url: siteURL + "?readdesign&outputformat=json",
  url:'latestviewcolums.json',
  dataType:'json'
    });
}

function ordercolumns(unsortedcolumn){
  var items = [];
  //console.log(unsortedcolumn);
  var cols = unsortedcolumn['column'];
  columns = [];

   cols.forEach( function(col){  
          columns.push(
                        {
                            id: col['@columnnumber'], 
                            name:col['@title'], 
                            field: col['@name'],
                            cssClass: "cell-selection", 
                            width: col['@width']*3,
                             cannotTriggerInsert: true, 
                             resizable: false,
                              selectable: true 
                          }

            );
         });
    return columns;
}


function formatDate(date){
  //console.log(date);
  datearray   = date.split(',');
  dateandtime = datearray[0].split('T');
  year        = dateandtime[0].substring(0, 4);
  month       = parseInt(dateandtime[0].substring(4, 6)) - 1; 
  day         = dateandtime[0].substring(6, 8); 
  hour        = dateandtime[1].substring(0, 2); 
  minute      = dateandtime[1].substring(2, 4); 
  sec         = dateandtime[1].substring(4, 6); 
  var date = new Date(Date.UTC(year, month,day, hour, minute, sec));
  return date.toLocaleString();
}

function getNewrows(startfrom, count){
if(typeof(Worker) !== "undefined") {
  
   primeWorker.postMessage([startfrom,count]);
   primeWorker.onmessage = function(element) {
      var here = element.data;
      console.log("start")
      console.log(here);
      console.log("now")
       if(here['viewentry']!=="undefined"){
                console.log(loopcount);
                getNewrows(queued[loopcount][0],queued[loopcount][1]);
                loopcount++;
                arrageData(here['viewentry']);
                grid.setData(data);
                grid.render();
              }
    };
} else {
    ajax++;
    $.ajax({
      type: "GET",
    //  url: siteURL + "?readviewentries&outputformat=json",
    data : { start : startfrom, count : count },
      url: 'latestviewentries.json',
       dataType:'json',
       success:function(newdata){
              if(queued[loopcount]){
                getNewrows(queued[loopcount][0],queued[loopcount][1]);
                loopcount++;
                arrageData(newdata['viewentry']);
                grid.setData(data);
                grid.render();
              }
            }
    });
  }


  
}

function getgriddata(){
  return $.ajax({
    type: "GET",
   // url: siteURL + "?readviewentries&outputformat=json&count=3000",
    url: 'latestviewentries.json',
     dataType:'json'
  });
}

function arrageData(unfromated){
   unfromated.forEach(function(rows){
             data[i] = {};
             row++;
       
            rows['entrydata'].forEach(function(cindcolum){
                if("text" in cindcolum){
                    data[i]['id']               =  cindcolum['@columnnumber']+row+" "+i;
                    data[i][cindcolum['@name']] =  cindcolum['text']['0'];
                }
                 else if("textlist" in cindcolum){
                    data[i]['id']               =  cindcolum['@columnnumber']+row+" "+i;
                    data[i][cindcolum['@name']] =  cindcolum['textlist']['text'][0];
                  }else if("number" in cindcolum){
                    data[i]['id']               =  cindcolum['@columnnumber']+row+" "+i;
                    data[i][cindcolum['@name']] =  cindcolum['number'][0];
                  }else if("datetime" in cindcolum){
                    data[i]['id']               =  cindcolum['@columnnumber']+row+" "+i;
                    var readableDate            =  formatDate(cindcolum['datetime'][0]);
                    data[i][cindcolum['@name']] =  readableDate;
                  }
              else{
                    alert('new format found!!! check console');
                
                   return false;
                 }
              
             });
             i++

           });
}

$(function () {
columnajax = getcolumn();
columnajax.done(function (allcolumns) {
    columns =  ordercolumns(allcolumns);
      datapromise = getgriddata();
     

      datapromise.done(function(newdata){
          var toplevelentries = newdata['@toplevelentries'];
          var percount        = newdata['viewentry'].length;
          totalrequest = Math.ceil(toplevelentries/percount); 
        

          
          arrageData(newdata['viewentry']);
          
           dataView = new Slick.Data.DataView({ inlineFilters: true });
            grid = new Slick.Grid("#myGrid", dataView, columns, options);
            grid.setSelectionModel(new Slick.RowSelectionModel());

            // wire up model events to drive the grid
            dataView.onRowCountChanged.subscribe(function (e, args) {
              grid.updateRowCount();
              grid.render();
            });

            dataView.onRowsChanged.subscribe(function (e, args) {
              grid.invalidateRows(args.rows);
              grid.render();
            });


          // initialize the model after all the events have been hooked up
          dataView.beginUpdate();
          dataView.setItems(data);
          dataView.setFilterArgs({
            percentCompleteThreshold: percentCompleteThreshold,
            searchString: searchString
          });
          dataView.setFilter(myFilter);
          dataView.endUpdate();

          // if you don't want the items that are not visible (due to being filtered out
          // or being on a different page) to stay selected, pass 'false' to the second arg
          dataView.syncGridSelection(grid, true);
          
          $("#gridContainer").resizable();
            for(k=1;k<totalrequest;k++){ 
               if(k==1)
                var apirequest = getNewrows((k * percount) + 1, percount);
                else{
                    start = (k * percount) + 1;
                    queued.push([start,percount]);
                }
              }
                
        })


      })

})
</script>
</body>
</html>